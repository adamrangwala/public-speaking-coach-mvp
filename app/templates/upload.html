{% extends "base.html" %}

{% block content %}
<div class="container" x-data="fileUpload()">
    <h1>Upload Your Speaking Video</h1>
    <p>Drag & drop your file here or click to select.</p>
    <div
        class="drop-area"
        :class="{ 'drag-over': isDragging }"
        @dragover.prevent="isDragging = true"
        @dragleave.prevent="isDragging = false"
        @drop.prevent="handleDrop"
        @click="$refs.fileInput.click()"
    >
        <form id="upload-form" action="/upload" method="post" enctype="multipart/form-data" class="hidden">
            <input type="file" name="file" @change="handleFileSelect" x-ref="fileInput">
        </form>
        <p x-show="!fileName">Drop file here or click to upload</p>
        <p x-show="fileName" x-text="fileName"></p>
        <div x-show="error" x-text="error" class="error-message"></div>
    </div>
    <button @click="submitForm" :disabled="!file" class="button">Analyze Video</button>
</div>

<script src="//unpkg.com/alpinejs" defer></script>
<script>
function fileUpload() {
    return {
        isDragging: false,
        file: null,
        fileName: '',
        error: '',
        handleDrop(event) {
            this.isDragging = false;
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                this.handleFile(files[0]);
            }
        },
        handleFileSelect(event) {
            const files = event.target.files;
            if (files.length > 0) {
                this.handleFile(files[0]);
            }
        },
        handleFile(file) {
            const MAX_SIZE = 50 * 1024 * 1024; // 50MB
            const ALLOWED_TYPES = ['video/mp4', 'video/quicktime', 'video/x-msvideo', 'video/webm'];

            this.error = '';
            this.fileName = '';

            if (file.size > MAX_SIZE) {
                this.error = 'File is too large (max 50MB).';
                this.file = null;
                return;
            }

            if (!ALLOWED_TYPES.includes(file.type)) {
                this.error = 'Invalid file type. Please upload MP4, MOV, AVI, or WEBM.';
                this.file = null;
                return;
            }

            this.file = file;
            this.fileName = file.name;
        },
        submitForm() {
            if (this.file) {
                const form = document.getElementById('upload-form');
                const formData = new FormData(form);
                // Since the file input might not be in the form data if dropped, append it.
                if (!formData.has('file')) {
                    formData.append('file', this.file, this.fileName);
                }
                
                // Use fetch to submit the form
                fetch('/upload', {
                    method: 'POST',
                    body: formData
                })
                .then(response => {
                    if (response.ok) {
                        // Redirect to the new page
                        window.location.href = response.url;
                    } else {
                        response.json().then(data => {
                            this.error = data.detail || 'An unknown error occurred.';
                        });
                    }
                })
                .catch(err => {
                    this.error = 'Upload failed. Please try again.';
                    console.error('Error:', err);
                });
            }
        }
    }
}
</script>
<style>
.drop-area {
    border: 2px dashed var(--border);
    border-radius: var(--radius);
    padding: 40px;
    text-align: center;
    cursor: pointer;
    transition: background-color 0.2s;
}
.drop-area.drag-over {
    background-color: #f0f0f0;
    border-color: var(--primary);
}
.hidden {
    display: none;
}
.error-message {
    color: #e74c3c;
    margin-top: 10px;
}
</style>
{% endblock %}