{% extends "base.html" %}

{% block content %}
<div class="container" x-data="textAnalysisApp({{ video_id }})">
    <h1>3. Audio Transcription Review</h1>
    <p>Listen to the audio, transcribe your speech, and use the prompts to analyze your content.</p>

    <!-- Audio Player -->
    <div class="audio-container">
        <audio controls width="100%">
            <source src="{{ video.upload_url }}" type="{{ video.mime_type }}">
            Your browser does not support the audio tag.
        </audio>
    </div>

    <!-- Transcript Area -->
    <div class="transcript-area card">
        <h2>Speech Transcript</h2>
        <textarea
            rows="15"
            placeholder="Paste or type your speech transcript here..."
            x-model="transcript"
            @input.debounce.500ms="saveTranscript"
        ></textarea>
        <div x-text="transcriptStatus.message"
             :class="{ 'saved': transcriptStatus.saved }"
             class="status-message"
             :style="{ opacity: transcriptStatus.message ? 1 : 0 }">
        </div>
    </div>

    <!-- Prompts and Notes -->
    <div class="notes-section">
        <h2>Guided Prompts</h2>
        {% for prompt in prompts %}
        <div class="prompt-card" x-data="{ content: '{{ prompt.content or '' }}' }">
            <label for="prompt-{{ prompt.id }}">{{ prompt.question }}</label>
            <textarea
                id="prompt-{{ prompt.id }}"
                rows="4"
                x-model="content"
                @input.debounce.500ms="saveNote({{ prompt.id }}, content)"
                placeholder="Type your notes here..."
            ></textarea>
            <div x-text="status['{{ prompt.id }}']?.message"
                 :class="{ 'saved': status['{{ prompt.id }}']?.saved }"
                 class="status-message"
                 :style="{ opacity: status['{{ prompt.id }}']?.message ? 1 : 0 }">
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Page Navigation -->
    <div class="page-navigation">
        <a href="/video/{{ video_id }}" class="button secondary">Previous: Video Image</a>
        <a href="/report/{{ video_id }}" class="button">Finish & View Report</a>
    </div>
</div>

<script src="//unpkg.com/alpinejs" defer></script>
<script>
function textAnalysisApp(videoId) {
    return {
        videoId: videoId,
        transcript: `{{ video.transcript or '' | e }}`,
        transcriptStatus: { message: '', saved: false },
        status: {},
        saveTranscript() {
            this.transcriptStatus = { message: 'Saving...', saved: false };
            fetch('/api/transcript', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    video_id: this.videoId,
                    content: this.transcript
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.status === 'success') {
                    this.transcriptStatus = { message: 'Saved!', saved: true };
                } else {
                    this.transcriptStatus = { message: `Error: ${data.detail || 'Unknown error'}`, saved: false };
                }
                setTimeout(() => { this.transcriptStatus = { message: '', saved: false }; }, 2000);
            })
            .catch(() => {
                this.transcriptStatus = { message: 'Error: Could not connect.', saved: false };
                setTimeout(() => { this.transcriptStatus = { message: '', saved: false }; }, 2000);
            });
        },
        saveNote(promptId, content) {
            this.status[promptId] = { message: 'Saving...', saved: false };
            fetch('/api/notes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    video_id: this.videoId,
                    prompt_id: promptId,
                    view_type: 'text',
                    content: content
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    this.status[promptId] = { message: 'Saved!', saved: true };
                } else {
                    this.status[promptId] = { message: `Error: ${data.detail || 'Unknown error'}`, saved: false };
                }
                setTimeout(() => { this.status[promptId] = { message: '', saved: false }; }, 2000);
            })
            .catch(() => {
                this.status[promptId] = { message: 'Error: Could not connect to server.', saved: false };
                setTimeout(() => { this.status[promptId] = { message: '', saved: false }; }, 2000);
            });
        }
    }
}
</script>
<style>
.card {
    background-color: #fff;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: var(--shadow);
}
.audio-container {
    margin-bottom: 20px;
}
audio {
    width: 100%;
}
.transcript-area textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    resize: vertical;
    box-sizing: border-box;
}
.view-navigation {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    border-bottom: 1px solid var(--border);
    padding-bottom: 10px;
}
.nav-link {
    text-decoration: none;
    color: var(--text);
    padding: 8px 15px;
    border-radius: var(--radius);
    transition: background-color 0.2s;
}
.nav-link.active {
    background-color: var(--primary);
    color: #fff;
}
.nav-link:hover:not(.active) {
    background-color: #f0f0f0;
}
.prompt-card {
    background-color: #fff;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 15px;
}
.prompt-card label {
    display: block;
    font-weight: bold;
    margin-bottom: 10px;
}
.prompt-card textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    resize: vertical;
    box-sizing: border-box;
}
.status-message {
    font-size: 0.9em;
    color: #888;
    text-align: right;
    margin-top: 5px;
    height: 1em;
    transition: opacity 0.5s;
}
.status-message.saved {
    color: green;
    opacity: 1;
}
</style>
{% endblock %}