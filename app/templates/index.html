{% extends "base.html" %}

{% block content %}
<div class="container">
    <!-- Upload Section -->
    <div class="upload-section card" x-data="fileUpload()">
        <h2>Upload a New Video</h2>
        <p>Drag & drop your file here or click to select.</p>
        <div
            class="drop-area"
            :class="{ 'drag-over': isDragging }"
            @dragover.prevent="isDragging = true"
            @dragleave.prevent="isDragging = false"
            @drop.prevent="handleDrop"
            @click="$refs.fileInput.click()"
        >
            <form id="upload-form" action="/upload" method="post" enctype="multipart/form-data" class="hidden">
                <input type="file" name="file" @change="handleFileSelect" x-ref="fileInput">
            </form>
            <p x-show="!fileName">Drop file here or click to upload</p>
            <p x-show="fileName" x-text="fileName"></p>
            <div x-show="error" x-text="error" class="error-message"></div>
        </div>
        <div x-show="isUploading" class="progress-bar-container">
            <div class="progress-bar" :style="`width: ${progress}%`">
                <span x-text="progress > 0 ? `${progress}%` : ''"></span>
            </div>
        </div>
        <button @click="submitForm" :disabled="!file || isUploading" class="button">
            <span x-show="!isUploading">Analyze Video</span>
            <span x-show="isUploading">Uploading...</span>
        </button>
    </div>

    <!-- Previous Videos Section -->
    <div class="previous-videos-section card" x-data="videoList()">
        <h2>Previous Analyses</h2>
        <div x-show="error" x-text="error" class="error-message" style="margin-bottom: 15px;"></div>
        {% if videos %}
            <ul class="video-list">
                {% for video in videos %}
                <li class="video-list-item" style="display: flex; align-items: center;">
                    <a href="/video/{{ video.id }}" style="flex-grow: 1; text-decoration: none; color: inherit; display: flex; justify-content: space-between; padding: 15px;">
                        <span class="filename">{{ video.original_filename }}</span>
                        <span class="date" data-created-at="{{ video.created_at }}"></span>
                    </a>
                    <button @click.prevent.stop="deleteVideo({{ video.id }}, $event)" class="delete-button" style="background: none; border: none; cursor: pointer; color: #e74c3c; padding: 0 15px;">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                    </button>
                </li>
                {% endfor %}
            </ul>
        {% else %}
            <div class="empty-state" style="text-align: center; padding: 40px;">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" style="color: #ccc; margin-bottom: 20px;"><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"></path><circle cx="12" cy="13" r="3"></circle></svg>
                <h3>Ready to improve?</h3>
                <p>Upload your first video to get started with your analysis.</p>
            </div>
        {% endif %}
    </div>
</div>

<script src="//unpkg.com/alpinejs" defer></script>
<script>
function fileUpload() {
    return {
        isDragging: false,
        file: null,
        fileName: '',
        error: '',
        progress: 0,
        isUploading: false,
        handleDrop(event) {
            this.isDragging = false;
            const files = event.dataTransfer.files;
            if (files.length > 0) {
                this.handleFile(files[0]);
            }
        },
        handleFileSelect(event) {
            const files = event.target.files;
            if (files.length > 0) {
                this.handleFile(files[0]);
            }
        },
        handleFile(file) {
            const MAX_SIZE = 50 * 1024 * 1024; // 50MB
            const ALLOWED_TYPES = ['video/mp4', 'video/quicktime', 'video/x-msvideo', 'video/webm'];

            this.error = '';
            this.fileName = '';

            if (file.size > MAX_SIZE) {
                this.error = 'File is too large (max 50MB).';
                this.file = null;
                return;
            }

            if (!ALLOWED_TYPES.includes(file.type)) {
                this.error = 'Invalid file type. Please upload MP4, MOV, AVI, or WEBM.';
                this.file = null;
                return;
            }

            this.file = file;
            this.fileName = file.name;
        },
        submitForm() {
            if (this.file) {
                this.isUploading = true;
                this.progress = 0;
                this.error = '';

                const formData = new FormData();
                formData.append('file', this.file, this.fileName);

                const xhr = new XMLHttpRequest();

                xhr.upload.addEventListener('progress', (event) => {
                    if (event.lengthComputable) {
                        const percentComplete = Math.round((event.loaded / event.total) * 100);
                        this.progress = percentComplete;
                    }
                });

                xhr.addEventListener('load', () => {
                    this.isUploading = false;
                    if (xhr.status >= 200 && xhr.status < 300) {
                        if (xhr.responseURL) {
                            window.location.href = xhr.responseURL;
                        } else {
                            this.error = 'Upload successful, but redirect failed. Please refresh.';
                        }
                    } else {
                        try {
                            const data = JSON.parse(xhr.responseText);
                            this.error = data.detail || 'An unknown error occurred.';
                        } catch (e) {
                            this.error = `An error occurred: ${xhr.statusText}`;
                        }
                    }
                });

                xhr.addEventListener('error', () => {
                    this.isUploading = false;
                    this.error = 'Upload failed. Please try again.';
                    console.error('Error:', xhr.statusText);
                });

                xhr.open('POST', '/upload', true);
                xhr.send(formData);
            }
        }
    }
}

function videoList() {
    return {
        error: '',
        deleteVideo(videoId, event) {
            if (!confirm('Are you sure you want to delete this analysis? This action cannot be undone.')) {
                return;
            }
            
            const listItem = event.currentTarget.closest('.video-list-item');

            fetch(`/api/video/${videoId}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.ok) {
                    listItem.remove();
                } else {
                    response.json().then(data => {
                        this.error = data.detail || 'Failed to delete video.';
                    }).catch(() => {
                        this.error = 'Failed to delete video and could not parse error response.';
                    });
                }
            })
            .catch(err => {
                this.error = 'An error occurred while deleting the video.';
                console.error('Error:', err);
            });
        }
    }
}

document.addEventListener('DOMContentLoaded', function () {
    const dateElements = document.querySelectorAll('.date[data-created-at]');
    dateElements.forEach(function(element) {
        const createdAt = element.getAttribute('data-created-at');
        const isoTimestamp = createdAt.replace(' ', 'T') + 'Z';
        const date = new Date(isoTimestamp);
        element.textContent = timeago.format(date);
    });
});
</script>
<style>
.card {
    background-color: #fff;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: var(--shadow);
}
.drop-area {
    border: 2px dashed var(--border);
    border-radius: var(--radius);
    padding: 40px;
    text-align: center;
    cursor: pointer;
    transition: background-color 0.2s;
    margin-top: 15px;
    margin-bottom: 15px;
}
.drop-area.drag-over {
    background-color: #f0f0f0;
    border-color: var(--primary);
}
.hidden {
    display: none;
}
.error-message {
    color: #e74c3c;
    margin-top: 10px;
}
.video-list {
    list-style: none;
    padding: 0;
}
.video-list-item a {
    display: flex;
    justify-content: space-between;
    padding: 15px;
    border-radius: var(--radius);
    text-decoration: none;
    color: var(--text);
    transition: background-color 0.2s;
    border-bottom: 1px solid var(--border);
}
.video-list-item:last-child a {
    border-bottom: none;
}
.video-list-item a:hover {
    background-color: #f9f9f9;
}
.filename {
    font-weight: bold;
}
.date {
    color: #888;
    font-size: 0.9em;
}
</style>
{% endblock %}