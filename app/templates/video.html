{% extends "base.html" %}

{% block content %}
<div class="container" x-data="notesApp({{ video_id }}, 'video')">
    <h1>2. Video Image Review</h1>
    <p>Watch the video (muted) and reflect on your body language using the prompts below.</p>

    <!-- Video Player -->
    <div class="video-container">
        <video id="hls-video" controls muted width="100%"></video>
    </div>

    <!-- Prompts and Notes -->
    <div class="notes-section">
        <h2>Guided Prompts</h2>
        {% for prompt in prompts %}
        <div class="prompt-card" x-data="{ content: '{{ prompt.content or '' }}' }">
            <label for="prompt-{{ prompt.id }}">{{ prompt.question }}</label>
            <textarea
                id="prompt-{{ prompt.id }}"
                rows="4"
                x-model="content"
                @input.debounce.500ms="saveNote({{ prompt.id }}, content)"
                placeholder="Type your notes here..."
            ></textarea>
            <div x-text="status['{{ prompt.id }}']?.message"
                 :class="{ 'saved': status['{{ prompt.id }}']?.saved }"
                 class="status-message"
                 :style="{ opacity: status['{{ prompt.id }}']?.message ? 1 : 0 }">
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Page Navigation -->
    <div class="page-navigation">
        <a href="/audio/{{ video_id }}" class="button secondary">Previous: Audio Image</a>
        <a href="/text/{{ video_id }}" class="button">Next: Transcription</a>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script src="//unpkg.com/alpinejs" defer></script>
<script>
document.addEventListener('DOMContentLoaded', function () {
    var video = document.getElementById('hls-video');
    var videoSrc = '{{ video.hls_playlist_url or video.upload_url }}';
    
    if (videoSrc && videoSrc.includes('.m3u8')) {
        if (Hls.isSupported()) {
            var hls = new Hls();
            hls.loadSource(videoSrc);
            hls.attachMedia(video);
        } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            video.src = videoSrc;
        }
    } else if (videoSrc) {
        video.src = videoSrc;
    }
});

function notesApp(videoId, viewType) {
    return {
        videoId: videoId,
        viewType: viewType,
        status: {},
        saveNote(promptId, content) {
            this.status[promptId] = { message: 'Saving...', saved: false };
            fetch('/api/notes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    video_id: this.videoId,
                    prompt_id: promptId,
                    view_type: this.viewType,
                    content: content
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    this.status[promptId] = { message: 'Saved!', saved: true };
                } else {
                    this.status[promptId] = { message: `Error: ${data.detail || 'Unknown error'}`, saved: false };
                }
                setTimeout(() => { this.status[promptId] = { message: '', saved: false }; }, 2000);
            })
            .catch(() => {
                this.status[promptId] = { message: 'Error: Could not connect to server.', saved: false };
                setTimeout(() => { this.status[promptId] = { message: '', saved: false }; }, 2000);
            });
        }
    }
}
</script>
<style>
.video-container {
    margin-bottom: 20px;
    background: #000;
    border-radius: var(--radius);
    overflow: hidden;
}
.view-navigation {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    border-bottom: 1px solid var(--border);
    padding-bottom: 10px;
}
.nav-link {
    text-decoration: none;
    color: var(--text);
    padding: 8px 15px;
    border-radius: var(--radius);
    transition: background-color 0.2s;
}
.nav-link.active {
    background-color: var(--primary);
    color: #fff;
}
.nav-link:hover:not(.active) {
    background-color: #f0f0f0;
}
.prompt-card {
    background-color: #fff;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 15px;
}
.prompt-card label {
    display: block;
    font-weight: bold;
    margin-bottom: 10px;
}
.prompt-card textarea {
    width: 100%;
    padding: 10px;
    border: 1px solid var(--border);
    border-radius: var(--radius);
    resize: vertical;
    box-sizing: border-box; /* Important for width */
}
.status-message {
    font-size: 0.9em;
    color: #888;
    text-align: right;
    margin-top: 5px;
    height: 1em;
    transition: opacity 0.5s;
}
.status-message.saved {
    color: green;
    opacity: 1;
}
</style>
{% endblock %}